<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Content-Security-Policy"
      content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.gstatic.com https://www.googleapis.com;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
        font-src https://fonts.gstatic.com;
        connect-src 'self' https://*.googleapis.com https://*.firebaseio.com https://my-todolist-38c20.firebaseapp.com https://firestore.googleapis.com wss://*.firebaseio.com;
        img-src 'self' data: https:;
      "
    />
    <title>Login - ToDo App</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/style.css" />
  </head>

  <body>
    <div class="container">
      <div class="card">
        <div class="logo">
          <h1>TodoApp</h1>
          <p>Organize your tasks beautifully</p>
        </div>

        <!-- Form Login -->
        <form id="loginForm">
          <div class="form-group">
            <label for="email">Email Address</label>
            <div class="input-wrapper">
              <input
                type="email"
                id="email"
                placeholder="Enter your email"
                autocomplete="username"
                required
              />
              <div class="input-icon">@</div>
            </div>
          </div>

          <div class="form-group">
            <label for="password">Password</label>
            <div class="input-wrapper">
              <input
                type="password"
                id="password"
                placeholder="Enter your password"
                autocomplete="current-password"
                required
              />
              <div class="input-icon">ðŸ”’</div>
            </div>
          </div>

          <div class="button-group">
            <button type="submit" class="btn-primary" id="loginBtn">
              Sign In
            </button>

            <div class="divider"><span>or</span></div>

            <button type="button" class="btn-secondary" id="registerBtn">
              Create Account
            </button>
          </div>

          <div class="message" id="messageBox"></div>
        </form>

        <div class="footer">
          <p>TodoApp Â©Rafizhaf</p>
        </div>
      </div>
    </div>

    <!-- Script Module -->
    <script type="module">
      import { auth } from "./firebase-config.js";
      import {
        signInWithEmailAndPassword,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

      const form = document.getElementById("loginForm");
      const loginBtn = document.getElementById("loginBtn");
      const registerBtn = document.getElementById("registerBtn");
      const messageBox = document.getElementById("messageBox");

      /** Fungsi menampilkan pesan sukses/error */
      function showMessage(text, type = "success") {
        messageBox.textContent = text;
        messageBox.className = "message " + type;
        messageBox.style.display = "block";

        setTimeout(() => {
          messageBox.style.display = "none";
        }, 3500);
      }

      /** Tombol Register â€” redirect ke register.html */
      if (registerBtn) {
        registerBtn.addEventListener("click", (e) => {
          e.preventDefault();
          showMessage("ðŸ”„ Mengalihkan ke halaman pendaftaran...", "success");
          setTimeout(() => {
            window.location.href = "register.html";
          }, 900);
        });
      }

      /** Proses Login */
      if (form) {
        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const email = document.getElementById("email").value.trim();
          const password = document.getElementById("password").value;

          if (!email || !password) {
            showMessage("âš ï¸ Harap isi semua kolom.", "error");
            return;
          }

          // Disable button saat proses login
          loginBtn.disabled = true;
          loginBtn.textContent = "Signing in...";

          try {
            const userCredential = await signInWithEmailAndPassword(
              auth,
              email,
              password
            );

            showMessage("âœ… Login berhasil! Mengalihkan...", "success");
            console.log("Login success:", userCredential.user);

            setTimeout(() => {
              window.location.href = "todo.html";
            }, 1500);
          } catch (err) {
            console.error("Login error:", err.code);

            let errorMessage = "Terjadi kesalahan saat login.";
            switch (err.code) {
              case "auth/invalid-credential":
                errorMessage = "Email atau password salah.";
                break;
              case "auth/user-not-found":
                errorMessage = "Akun tidak ditemukan. Silakan daftar dulu.";
                break;
              case "auth/wrong-password":
                errorMessage = "Password salah. Silakan coba lagi.";
                break;
              case "auth/too-many-requests":
                errorMessage = "Terlalu banyak percobaan. Coba lagi nanti.";
                break;
              case "auth/invalid-email":
                errorMessage = "Format email tidak valid.";
                break;
            }

            showMessage("âŒ " + errorMessage, "error");
            
            // Re-enable button
            loginBtn.disabled = false;
            loginBtn.textContent = "Sign In";
          }
        });
      }

      /** Redirect otomatis jika user sudah login */
      onAuthStateChanged(auth, (user) => {
        if (user) {
          console.log("User sudah login, mengalihkan...");
          window.location.href = "todo.html";
        }
      });
    </script>
  </body>
</html>